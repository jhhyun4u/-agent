# Phase 기반 컨텍스트 관리 및 적응형 HITL 설계안

> **v3.0 → v3.1 → v3.1.1 아키텍처 확장**
> 기존 Supervisor + Sub-agent 구조 위에 **5-Phase 컨텍스트 격리** 계층과
> **적응형 HITL 게이트**를 추가하여, 컨텍스트 폭발 문제를 해결하고
> 사람의 개입을 최적화합니다.
>
> **v3.1.1 보완**: Design Review 13건 (C-1~C-4, M-1~M-5, m-2~m-4) +
> Token Efficiency Review 12건 (#1~#11) 반영.
> HITL interrupt() 전면 재설계, Phase 5 품질 루프, 캐시 워밍업,
> RAG 사전 수집, 2단계 비평, 적응형 수정, TokenUsageTracker 통합.

---

## 목차

1. [문제 진단: 왜 Phase가 필요한가](#1-문제-진단-왜-phase가-필요한가)
2. [5-Phase 모델 설계](#2-5-phase-모델-설계)
3. [Phase Artifact: 컨텍스트 압축 프로토콜](#3-phase-artifact-컨텍스트-압축-프로토콜)
4. [적응형 HITL 게이트 설계](#4-적응형-hitl-게이트-설계)
5. [Supervisor 그래프 재설계](#5-supervisor-그래프-재설계)
6. [Phase별 상세 설계](#6-phase별-상세-설계)
7. [컨텍스트 예산 시뮬레이션](#7-컨텍스트-예산-시뮬레이션)
8. [정보 손실 방지 전략](#8-정보-손실-방지-전략)
9. [전체 실행 예시](#9-전체-실행-예시)

---

## 1. 문제 진단: 왜 Phase가 필요한가

### 1.1 v3.0의 컨텍스트 누적 문제

```
v3.0 현재 흐름 (컨텍스트가 계속 쌓임):

  시작  ──────────────────────────────────────────────────▶  끝
  │                                                         │
  │ RFP 원문     + 분석 결과   + 전략       + 참조 자료     │
  │ (~25K tok)   (+15K tok)   (+10K tok)   (+20K tok)      │
  │                                                         │
  │              + 인력 배정   + 9개 섹션   + 비평 결과     │
  │              (+5K tok)    (+80K tok)   (+10K tok)       │
  │                                                         │
  └── 누적 컨텍스트: ~165K 토큰 (한국어 기준) ──────────────┘
                                                    ↑
                                        Claude Sonnet 200K 한도에 근접
                                        (안전 마진 80% = 160K 초과!)
```

### 1.2 Phase 도입으로 해결

```
Phase 기반 흐름 (Phase 경계에서 컨텍스트 압축):

  Phase 1      Phase 2       Phase 3       Phase 4       Phase 5
  Research     Analysis      Plan          Implement     Test
  ┌────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
  │        │  │          │  │          │  │          │  │          │
  │ RFP    │  │ Artifact │  │ Artifact │  │ Artifact │  │ Artifact │
  │ 원문   │  │ #1       │  │ #2       │  │ #3       │  │ #4       │
  │ +참조  │  │ +분석    │  │ +전략    │  │ +섹션    │  │ +전체    │
  │        │  │          │  │          │  │          │  │          │
  │ ~45K   │  │ ~35K     │  │ ~30K     │  │ ~60K     │  │ ~50K     │
  └───┬────┘  └───┬──────┘  └───┬──────┘  └───┬──────┘  └───┬──────┘
      │           │             │             │             │
      ▼           ▼             ▼             ▼             ▼
   Artifact    Artifact      Artifact      Artifact      최종 출력
   #1 (8K)     #2 (10K)      #3 (12K)      #4 (15K)
      │           │             │             │
      ▼           ▼             ▼             ▼
   [HITL?]     [HITL?]       [HITL ✓]      [HITL?]      [HITL ✓]
   조건부       조건부        필수          조건부        필수

  각 Phase 최대 컨텍스트: ~60K 토큰 (200K의 30%)
  → 출력 여유 충분, 프롬프트 캐싱 효과 극대화
```

### 1.3 v3.0과 v3.1의 차이

```
┌─────────────────┬──────────────────────┬──────────────────────────────┐
│ 관점            │ v3.0                 │ v3.1 (Phase 기반)            │
├─────────────────┼──────────────────────┼──────────────────────────────┤
│ 컨텍스트 관리   │ 누적 (State에 전부)  │ Phase별 격리 + Artifact 전달│
│                 │ → 후반부 압박        │ → 각 Phase 독립 예산        │
├─────────────────┼──────────────────────┼──────────────────────────────┤
│ HITL            │ 3곳 고정             │ 5곳 적응형 (필수 2 + 조건 3)│
│                 │                      │ Supervisor가 동적 판단      │
├─────────────────┼──────────────────────┼──────────────────────────────┤
│ 정보 전달       │ State 전체 전달      │ Artifact (구조화 요약) 전달 │
│                 │                      │ + 원본 접근 가능 (필요 시)  │
├─────────────────┼──────────────────────┼──────────────────────────────┤
│ 에러 복구       │ 전체 State 롤백      │ Phase 단위 롤백 가능        │
│                 │                      │ (이전 Phase 결과물 보존)    │
├─────────────────┼──────────────────────┼──────────────────────────────┤
│ 병렬 처리       │ Sub-agent 내부만     │ Phase 4에서 섹션별 병렬     │
│                 │                      │ (각 섹션이 독립 컨텍스트)   │
├─────────────────┼──────────────────────┼──────────────────────────────┤
│ Sub-agent/Tool  │ 유지                 │ 유지 (Phase 안에서 동작)    │
│ MCP             │ 유지                 │ 유지                        │
└─────────────────┴──────────────────────┴──────────────────────────────┘
```

---

## 2. 5-Phase 모델 설계

### 2.1 제안서 작성에 매핑한 5-Phase

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  Phase 1: RESEARCH (수집)                                               │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │ "무엇을 요구하는가?"                                        │        │
│  │                                                             │        │
│  │ • RFP 문서 파싱 및 텍스트 추출                              │        │
│  │ • 과거 제안서 이력 검색 (RAG)                               │        │
│  │ • 경쟁 이력 조회                                            │        │
│  │ • 발주처 이전 사업 정보 수집                                │        │
│  │ • 회사 역량/인력 풀 현황 수집                               │        │
│  │                                                             │        │
│  │ Sub-agents: RFP 분석 (파싱만)                               │        │
│  │ MCP: proposal_db, personnel_db, rag_server, web_search      │        │
│  │ 산출물: PhaseArtifact_1 (수집된 원시 데이터의 구조화 요약)  │        │
│  └─────────────────────────────────────────────────────────────┘        │
│       │                                                                 │
│       ▼ [HITL Gate #1: 조건부] "수집 결과가 충분한가?"                  │
│                                                                         │
│  Phase 2: ANALYSIS (분석)                                               │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │ "핵심 쟁점은 무엇인가?"                                     │        │
│  │                                                             │        │
│  │ • RFP 구조화 분석 (배점, 필수 요건, 페이지 제한)           │        │
│  │ • 숨은 의도 추론                                            │        │
│  │ • 발주처 언어 프로파일 추출                                 │        │
│  │ • 경쟁 환경 분석                                            │        │
│  │ • 자격 요건 충족 여부 검증                                  │        │
│  │ • 배점 기반 자원 배분 계산                                  │        │
│  │                                                             │        │
│  │ Sub-agents: RFP 분석 (분석), 전략 수립 (경쟁 분석)          │        │
│  │ Tools: score_allocation, check_traceability                 │        │
│  │ 산출물: PhaseArtifact_2 (분석 결과 + 핵심 인사이트)        │        │
│  └─────────────────────────────────────────────────────────────┘        │
│       │                                                                 │
│       ▼ [HITL Gate #2: 조건부] "분석이 정확한가?"                       │
│                                                                         │
│  Phase 3: PLAN (전략 수립)                                              │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │ "어떻게 이길 것인가?"                                       │        │
│  │                                                             │        │
│  │ • 핵심 전략 메시지 수립                                     │        │
│  │ • 섹션별 작성 전략 및 분량 배분                             │        │
│  │ • 인력 배정 (필수 자격 매칭)                                │        │
│  │ • 시각 자료 계획                                            │        │
│  │ • 섹션 간 의존성 및 생성 순서 결정                          │        │
│  │                                                             │        │
│  │ Sub-agents: 전략 수립                                       │        │
│  │ MCP: personnel_db, proposal_db                              │        │
│  │ 산출물: PhaseArtifact_3 (전략 + 실행 계획)                 │        │
│  └─────────────────────────────────────────────────────────────┘        │
│       │                                                                 │
│       ▼ [HITL Gate #3: ★필수★] "이 전략으로 진행해도 되는가?"           │
│                                                                         │
│  Phase 4: IMPLEMENT (작성)                                              │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │ "제안서를 작성하라"                                         │        │
│  │                                                             │        │
│  │ • 섹션별 본문 생성 (Phase 순서대로, 병렬)                   │        │
│  │ • 요구사항 추적성 매핑                                      │        │
│  │ • 시각 자료 생성 (Mermaid 다이어그램)                       │        │
│  │ ※ M-3: Executive Summary는 Phase 5로 이동                  │        │
│  │   (Phase 5 수정 후 작성해야 본문과 일치)                    │        │
│  │                                                             │        │
│  │ Sub-agents: 섹션 생성                                       │        │
│  │ Tools: generate_mermaid, check_traceability, estimate_pages │        │
│  │ MCP: rag_server, cost_calculator, document_store            │        │
│  │ 산출물: PhaseArtifact_4 (전체 섹션 초안)                   │        │
│  └─────────────────────────────────────────────────────────────┘        │
│       │                                                                 │
│       ▼ [HITL Gate #4: 조건부] "초안 방향이 맞는가?"                    │
│                                                                         │
│  Phase 5: TEST (검증 및 완성)                                           │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │ "품질을 보증하라"                                           │        │
│  │                                                             │        │
│  │ • 개별 섹션 비평 (병렬, Haiku) + 섹션 간 정합성 비평       │        │
│  │ • 적응형 수정 (심각도별 Sonnet/Haiku 선택)                 │        │
│  │ • 수정 → 재평가 루프 (max 3회, 그래프에 반영)              │        │
│  │ • 요약문(Executive Summary) 생성 (수정 완료 후)             │        │
│  │ • 최종 편집 (문체 통일, 분량 조정)                          │        │
│  │ • 템플릿 적용 및 문서 변환                                  │        │
│  │                                                             │        │
│  │ Sub-agents: 품질 관리, 문서 출력                            │        │
│  │ Tools: check_consistency, estimate_pages                    │        │
│  │ MCP: document_store                                         │        │
│  │ 산출물: 최종 제안서 파일                                    │        │
│  └─────────────────────────────────────────────────────────────┘        │
│       │                                                                 │
│       ▼ [HITL Gate #5: ★필수★] "제출해도 되는가?"                       │
│                                                                         │
│  ──▶ 완료                                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Phase ↔ Sub-agent 매핑

```
┌─────────────────────────────────────────────────────────────────────┐
│ Phase        │ v3.0 Sub-agent        │ 역할                        │
├─────────────────────────────────────────────────────────────────────┤
│ 1. Research  │ RFP 분석 (파싱 부분)  │ 문서 추출, 데이터 수집      │
│              │ (MCP 호출 중심)       │                             │
├──────────────┼───────────────────────┼─────────────────────────────┤
│ 2. Analysis  │ RFP 분석 (분석 부분)  │ 구조화 분석, 숨은 의도      │
│              │ 전략 수립 (경쟁 분석) │ 경쟁 분석, 배점 배분        │
├──────────────┼───────────────────────┼─────────────────────────────┤
│ 3. Plan      │ 전략 수립 (전략+인력) │ 전략 메시지, 인력, 계획     │
├──────────────┼───────────────────────┼─────────────────────────────┤
│ 4. Implement │ 섹션 생성             │ 본문 작성, 시각 자료        │
│              │ 문서 출력 (요약문)    │                             │
├──────────────┼───────────────────────┼─────────────────────────────┤
│ 5. Test      │ 품질 관리             │ 비평, 수정, 정합성          │
│              │ 문서 출력 (편집+변환) │ 편집, 템플릿, 출력          │
└──────────────┴───────────────────────┴─────────────────────────────┘

핵심: Sub-agent 자체는 바뀌지 않음.
      Phase가 Sub-agent의 "실행 범위"를 제한하고,
      Phase 경계에서 컨텍스트를 정리하는 것.
```

---

✅ **다음 단계**: State 스키마(`PhasedSupervisorState`) + Artifact 정의(`PhaseArtifact_*`) 구현
